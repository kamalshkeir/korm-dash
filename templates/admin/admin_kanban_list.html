{{template "admin_base" .}}

{{define "admin_css"}}
<link rel="stylesheet" href="{{$.static_url}}/admin/css/pages/kanban.css">
<style>
    .boards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem 0;
    }

    .board-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 180px;
        text-decoration: none;
        color: inherit;
        position: relative;
    }

    .delete-board-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: transparent;
        border: none;
        color: #94a3b8;
        padding: 4px;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .board-card:hover .delete-board-btn {
        opacity: 1;
    }

    .delete-board-btn:hover {
        background-color: #fee2e2;
        color: #ef4444;
    }

    .dark-mode .delete-board-btn:hover {
        background-color: #450a0a;
        color: #fca5a5;
    }

    .dark-mode .board-card {
        background: #1e1e1e;
        border-color: #333;
    }

    .board-card:hover {
        transform: translateY(-4px);
        border-color: var(--theme-color);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .board-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1e293b;
    }

    .dark-mode .board-title {
        color: #f1f5f9;
    }

    .board-desc {
        color: #64748b;
        font-size: 0.9rem;
        flex-grow: 1;
    }

    .dark-mode .board-desc {
        color: #94a3b8;
    }

    .board-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.85rem;
        color: #94a3b8;
    }

    .dark-mode .board-meta {
        border-color: #333;
    }

    .new-board-card {
        border: 2px dashed var(--border-color);
        background: transparent;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
    }

    .new-board-card:hover {
        border-color: var(--theme-color);
        color: var(--theme-color);
        background: rgba(var(--theme-color), 0.05);
    }

    .new-board-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
    }
</style>
{{end}}

{{define "admin_title"}}My Boards{{end}}

{{define "admin_main_content"}}
<div class="app-layout">
    <nav-bar id="mainNav"></nav-bar>
    <main class="main-content">
        <app-header titre="My Kanban Boards" username="{{.User.Username}}" email="{{.User.Email}}"
            logout="{{$.admin_path}}/logout" restart="{{$.admin_path}}/restart"></app-header>
        <div class="content-area">

            <div class="boards-grid">
                <!-- Create New Board -->
                <button class="board-card new-board-card" onclick="createBoard()">
                    <svg class="new-board-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                    <span style="font-weight: 600;">Create New Board</span>
                </button>

                {{range .Boards}}
                <div class="board-card" data-url="{{$.admin_path}}/kanbans/{{.Id}}" onclick="goToBoard(event)">
                    <button class="delete-board-btn" data-id="{{.Id}}" onclick="deleteBoard(event)"
                        title="Delete Board">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                    </button>
                    <div>
                        <h3 class="board-title">{{.Name}}</h3>
                        <p class="board-desc">{{.Description}}</p>
                    </div>
                    <div class="board-meta">
                        <span>Updated {{.UpdatedAt.Format "Jan 02, 15:04"}}</span>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </main>
</div>
{{end}}

{{define "admin_js"}}
<script src="{{$.static_url}}/admin/components/Modal.js" type="module"></script>
<script>
    var adminPath = "{{$.admin_path}}"

    function goToBoard(event) {
        const url = event.currentTarget.dataset.url;
        if (url) window.location.href = url;
    }

    async function deleteBoard(event) {
        event.stopPropagation();
        const btn = event.currentTarget;
        const id = btn.dataset.id;

        if (!confirm("Are you sure you want to delete this board? This cannot be undone.")) {
            return;
        }

        try {
            const response = await fetch(adminPath + '/kanbans/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: parseInt(id) })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete board');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    }

    async function createBoard() {
        const modalBody = `
            <div class="form-group">
                <label for="boardName">Board Name</label>
                <input type="text" id="boardName" class="form-control" placeholder="e.g. Product Roadmap">
            </div>
            <div class="form-group">
                <label for="boardDesc">Description</label>
                <textarea id="boardDesc" class="form-control" rows="3" placeholder="Optional description..."></textarea>
            </div>
            <div class="modal-footer">
                <button id="saveBoardBtn" class="btn btn-primary">Create Board</button>
            </div>
        `;

        const modalStyle = `
            :host {
                color: #1e293b;
            }
            /* Force header title to be dark (for light base theme) */
            .header h1 {
                color: #1e293b !important;
            }
            .form-group { margin-bottom: 1.5rem; }
            .form-control {
                width: 100%;
                padding: 0.75rem 1rem;
                background-color: #fff;
                border: 1px solid #cbd5e1;
                border-radius: 0.5rem;
                font-size: 0.95rem;
                margin-top: 0.5rem;
                transition: all 0.2s;
                color: #1e293b;
            }
            .form-control:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            label { 
                font-weight: 600; 
                font-size: 0.875rem; 
                color: #475569;
                display: block;
                margin-bottom: 0.25rem;
            }
            .modal-footer { 
                display: flex; 
                justify-content: flex-end; 
                margin-top: 2rem; 
                padding-top: 1rem;
                border-top: 1px solid #e2e8f0;
            }
            .btn {
                padding: 0.6rem 1.25rem;
                border-radius: 0.5rem;
                font-weight: 500;
                cursor: pointer;
                border: 1px solid transparent;
                background: #3b82f6;
                color: white;
                font-size: 0.95rem;
                transition: all 0.2s;
            }
            .btn:hover { 
                background: #2563eb; 
                transform: translateY(-1px);
            }
            .btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
        `;

        // Load Modal module dynamically if not available globally (though we imported it in script tag)
        // Since Modal.js defines a global function Modal, we can use it.

        await Modal("Create New Board", modalBody, modalStyle, (modalInstance) => {
            const btn = modalInstance.shadowRoot.getElementById('saveBoardBtn');
            const nameInput = modalInstance.shadowRoot.getElementById('boardName');
            const descInput = modalInstance.shadowRoot.getElementById('boardDesc');

            // Focus name input
            setTimeout(() => nameInput.focus(), 100);

            btn.addEventListener('click', async () => {
                const name = nameInput.value;
                const description = descInput.value;

                if (!name) {
                    nameInput.style.borderColor = 'red';
                    return;
                }

                btn.textContent = 'Creating...';
                btn.disabled = true;

                try {
                    const response = await fetch(adminPath + '/kanbans/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });

                    if (response.ok) {
                        modalInstance.close();
                        window.location.reload();
                    } else {
                        alert('Failed to create board');
                        btn.textContent = 'Create Board';
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred');
                    btn.textContent = 'Create Board';
                    btn.disabled = false;
                }
            });
        });
    }
</script>
<script src="{{$.static_url}}/admin/js/kanban.js"></script>
{{end}}